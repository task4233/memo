<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Rustでシングルスレッドサーバを作ってみる</title>
    <meta name="description" content="Rustのシングルスレッドサーバ記事の例">
    
    
    <link rel="preload" href="/assets/css/0.styles.927c50e1.css" as="style"><link rel="preload" href="/assets/js/app.e447834c.js" as="script"><link rel="preload" href="/assets/js/4.ea1d030e.js" as="script"><link rel="preload" href="/assets/js/45.d3084f6f.js" as="script"><link rel="prefetch" href="/assets/js/10.5fb78c6b.js"><link rel="prefetch" href="/assets/js/11.00a32e57.js"><link rel="prefetch" href="/assets/js/12.9753e7a4.js"><link rel="prefetch" href="/assets/js/13.4f4cba50.js"><link rel="prefetch" href="/assets/js/14.487fd3e0.js"><link rel="prefetch" href="/assets/js/15.fff641af.js"><link rel="prefetch" href="/assets/js/16.e24f8c23.js"><link rel="prefetch" href="/assets/js/17.e5931d87.js"><link rel="prefetch" href="/assets/js/18.c76a41c9.js"><link rel="prefetch" href="/assets/js/19.69fd1a13.js"><link rel="prefetch" href="/assets/js/2.e4b447ce.js"><link rel="prefetch" href="/assets/js/20.1d5aa23a.js"><link rel="prefetch" href="/assets/js/21.7456dddc.js"><link rel="prefetch" href="/assets/js/22.43561a19.js"><link rel="prefetch" href="/assets/js/23.f9ab2c6c.js"><link rel="prefetch" href="/assets/js/24.572a4c17.js"><link rel="prefetch" href="/assets/js/25.da0470d9.js"><link rel="prefetch" href="/assets/js/26.1498e92e.js"><link rel="prefetch" href="/assets/js/27.1b5e231b.js"><link rel="prefetch" href="/assets/js/28.7ff35c37.js"><link rel="prefetch" href="/assets/js/29.fc487f01.js"><link rel="prefetch" href="/assets/js/3.685664ec.js"><link rel="prefetch" href="/assets/js/30.3d0a5dee.js"><link rel="prefetch" href="/assets/js/31.6fb8f56c.js"><link rel="prefetch" href="/assets/js/32.eb72ad8c.js"><link rel="prefetch" href="/assets/js/33.02308810.js"><link rel="prefetch" href="/assets/js/34.6684b118.js"><link rel="prefetch" href="/assets/js/35.54494384.js"><link rel="prefetch" href="/assets/js/36.9c621ce9.js"><link rel="prefetch" href="/assets/js/37.540c8a48.js"><link rel="prefetch" href="/assets/js/38.03386e31.js"><link rel="prefetch" href="/assets/js/39.1242d758.js"><link rel="prefetch" href="/assets/js/40.480f85c3.js"><link rel="prefetch" href="/assets/js/41.4b5ba5a3.js"><link rel="prefetch" href="/assets/js/42.8cd7f453.js"><link rel="prefetch" href="/assets/js/43.71661e52.js"><link rel="prefetch" href="/assets/js/44.034fcd2c.js"><link rel="prefetch" href="/assets/js/46.fdf5f3bf.js"><link rel="prefetch" href="/assets/js/47.83ae43c4.js"><link rel="prefetch" href="/assets/js/48.69175fae.js"><link rel="prefetch" href="/assets/js/49.b9434479.js"><link rel="prefetch" href="/assets/js/5.93dd8e5f.js"><link rel="prefetch" href="/assets/js/50.62e4ceac.js"><link rel="prefetch" href="/assets/js/51.b5080153.js"><link rel="prefetch" href="/assets/js/52.868f2885.js"><link rel="prefetch" href="/assets/js/53.3313359d.js"><link rel="prefetch" href="/assets/js/54.eac3ac31.js"><link rel="prefetch" href="/assets/js/55.f8f80c24.js"><link rel="prefetch" href="/assets/js/56.915b9bdc.js"><link rel="prefetch" href="/assets/js/6.3684d401.js"><link rel="prefetch" href="/assets/js/7.462e790c.js"><link rel="prefetch" href="/assets/js/8.7999708e.js"><link rel="prefetch" href="/assets/js/9.ff1fb5db.js">
    <link rel="stylesheet" href="/assets/css/0.styles.927c50e1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="content__default"><h1 id="rustでシングルスレッドサーバを作ってみる"><a href="#rustでシングルスレッドサーバを作ってみる" aria-hidden="true" class="header-anchor">#</a> Rustでシングルスレッドサーバを作ってみる</h1> <p>以下に404 NOT FOUNDの実装を書いていきます。</p> <h2 id="_1-404-not-foundのページを作成する"><a href="#_1-404-not-foundのページを作成する" aria-hidden="true" class="header-anchor">#</a> 1. 404 NOT FOUNDのページを作成する</h2> <p>HTMLファイルに404 NOT FOUNDの旨を書けば良いです。</p> <p>一度作った<code>index.html</code>を真似して書いてみます。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- public/404.html --&gt;</span>
<span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>utf-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>404 NOT FOUND...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>I do not want to work...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>こんな感じで良いでしょう。</p> <h2 id="_2-404-not-foundのページを設定する"><a href="#_2-404-not-foundのページを設定する" aria-hidden="true" class="header-anchor">#</a> 2. 404 NOT FOUNDのページを設定する</h2> <p><code>src/main.rs</code>に追記すれば良いです。
設定したルーティング設定に引っかからなかったときに<code>404.html</code>を返せば良いので, そのように設定します。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// src/main.rs</span>

<span class="token comment">// ~~ 略 ~~</span>

<span class="token keyword">fn</span> <span class="token function">handle_connection</span><span class="token punctuation">(</span><span class="token keyword">mut</span> stream<span class="token punctuation">:</span> TcpStream<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// TcpStreamインスタンスのデータを読み取るためのバッファを用意</span>
  <span class="token keyword">let</span> <span class="token keyword">mut</span> buffer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  stream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> buffer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Request: {}&quot;</span><span class="token punctuation">,</span> String<span class="token punctuation">::</span><span class="token function">from_utf8_lossy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer<span class="token punctuation">[</span><span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> get <span class="token operator">=</span> <span class="token string">b&quot;GET / HTTP/1.1\r\n&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> buffer<span class="token punctuation">.</span><span class="token function">starts_with</span><span class="token punctuation">(</span>get<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> file <span class="token operator">=</span> File<span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;public/index.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> contents <span class="token operator">=</span> String<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    file<span class="token punctuation">.</span><span class="token function">read_to_string</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> contents<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> response <span class="token operator">=</span> <span class="token function">format!</span><span class="token punctuation">(</span><span class="token string">&quot;HTTP/1.1 200 OK\r\n\r\n{}&quot;</span><span class="token punctuation">,</span> contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
    stream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">as_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// streamに完全にwriteされるように, flush()を呼び出しておく</span>
    stream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span> <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>   <span class="token keyword">let</span> <span class="token keyword">mut</span> file <span class="token operator">=</span> File<span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;public/404.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>   <span class="token keyword">let</span> <span class="token keyword">mut</span> contents <span class="token operator">=</span> String<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>   file<span class="token punctuation">.</span><span class="token function">read_to_string</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> contents<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>
<span class="token operator">+</span>   <span class="token keyword">let</span> response <span class="token operator">=</span> <span class="token function">format!</span><span class="token punctuation">(</span><span class="token string">&quot;HTTP/1.1 404 NOT FOUND\r\n\r\n{}&quot;</span><span class="token punctuation">,</span> contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>   stream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">as_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>   <span class="token comment">// streamに完全にwriteされるように, flush()を呼び出しておく</span>
<span class="token operator">+</span>   stream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>以上です。これで<code>http://127.0.0.1:3000/</code>以外のURLでリクエストを飛ばすと, <code>public/404.html</code>の内容がレスポンスとして返されることが確認できると思います。</p> <h1 id="さらにリファクタリングしてみる"><a href="#さらにリファクタリングしてみる" aria-hidden="true" class="header-anchor">#</a> さらにリファクタリングしてみる</h1> <p>上のコードだとコードとして重複している部分が複数あります。
そこで, 重複している部分をまとめてみようと思います。</p> <p>よくコードを見ると, 異なっている部分はステータスコードとレスポンスとして返すファイルの場所のみであることがわかります。したがって, その2つを変数としてレスポンスを返してみます。</p> <p>コードは次の通りです。</p> <div class="language-rust extra-class"><pre class="language-rust"><code>src<span class="token operator">/</span>main<span class="token punctuation">.</span>rs

<span class="token comment">// ~~ 略 ~~</span>

<span class="token keyword">fn</span> <span class="token function">handle_connection</span><span class="token punctuation">(</span><span class="token keyword">mut</span> stream<span class="token punctuation">:</span> TcpStream<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// TcpStreamインスタンスのデータを読み取るためのバッファを用意</span>
  <span class="token keyword">let</span> <span class="token keyword">mut</span> buffer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  stream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> buffer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Request: {}&quot;</span><span class="token punctuation">,</span> String<span class="token punctuation">::</span><span class="token function">from_utf8_lossy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer<span class="token punctuation">[</span><span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> get <span class="token operator">=</span> <span class="token string">b&quot;GET / HTTP/1.1\r\n&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> <span class="token punctuation">(</span>status_line<span class="token punctuation">,</span> resource_path<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">if</span> buffer<span class="token punctuation">.</span><span class="token function">starts_with</span><span class="token punctuation">(</span>get<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token string">&quot;HTTP/1.1 200 OK\r\n\r\n&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;public/index.html&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token string">&quot;HTTP/1.1 404 NOT FOUND\r\n\r\n&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;public/404.html&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> <span class="token keyword">mut</span> file <span class="token operator">=</span> File<span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span>resource_path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token keyword">mut</span> contents <span class="token operator">=</span> String<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  file<span class="token punctuation">.</span><span class="token function">read_to_string</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> contents<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">let</span> response <span class="token operator">=</span> <span class="token function">format!</span><span class="token punctuation">(</span><span class="token string">&quot;{}{}&quot;</span><span class="token punctuation">,</span> status_line<span class="token punctuation">,</span> contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
  stream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">as_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// streamに完全にwriteされるように, flush()を呼び出しておく</span>
  stream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>お疲れ様でした。</p></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.e447834c.js" defer></script><script src="/assets/js/4.ea1d030e.js" defer></script><script src="/assets/js/45.d3084f6f.js" defer></script>
  </body>
</html>
