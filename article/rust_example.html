<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Rustでシングルスレッドサーバを作ってみる | Note</title>
    <meta name="description" content="Rustのシングルスレッドサーバ記事の例">
    
    
    <link rel="preload" href="/note/assets/css/0.styles.6ac3a915.css" as="style"><link rel="preload" href="/note/assets/js/app.114b3125.js" as="script"><link rel="preload" href="/note/assets/js/2.a525c827.js" as="script"><link rel="preload" href="/note/assets/js/54.60a0737a.js" as="script"><link rel="prefetch" href="/note/assets/js/10.8cf6419a.js"><link rel="prefetch" href="/note/assets/js/11.96cc4848.js"><link rel="prefetch" href="/note/assets/js/12.6c4def18.js"><link rel="prefetch" href="/note/assets/js/13.b12acfee.js"><link rel="prefetch" href="/note/assets/js/14.63a217ab.js"><link rel="prefetch" href="/note/assets/js/15.64c874fe.js"><link rel="prefetch" href="/note/assets/js/16.5550848e.js"><link rel="prefetch" href="/note/assets/js/17.fef47497.js"><link rel="prefetch" href="/note/assets/js/18.d392f9c3.js"><link rel="prefetch" href="/note/assets/js/19.8738d888.js"><link rel="prefetch" href="/note/assets/js/20.1d3f1329.js"><link rel="prefetch" href="/note/assets/js/21.e3f825d4.js"><link rel="prefetch" href="/note/assets/js/22.aedc4bb5.js"><link rel="prefetch" href="/note/assets/js/23.06fa5ce5.js"><link rel="prefetch" href="/note/assets/js/24.5494ef4e.js"><link rel="prefetch" href="/note/assets/js/25.900a3579.js"><link rel="prefetch" href="/note/assets/js/26.78bad4f5.js"><link rel="prefetch" href="/note/assets/js/27.b5d84715.js"><link rel="prefetch" href="/note/assets/js/28.db50031e.js"><link rel="prefetch" href="/note/assets/js/29.4f6d8bf7.js"><link rel="prefetch" href="/note/assets/js/3.1c7a6bc6.js"><link rel="prefetch" href="/note/assets/js/30.dd9aaaab.js"><link rel="prefetch" href="/note/assets/js/31.80f9d861.js"><link rel="prefetch" href="/note/assets/js/32.e84804ff.js"><link rel="prefetch" href="/note/assets/js/33.642eb593.js"><link rel="prefetch" href="/note/assets/js/34.650c84d7.js"><link rel="prefetch" href="/note/assets/js/35.aaf58c69.js"><link rel="prefetch" href="/note/assets/js/36.efdc87b0.js"><link rel="prefetch" href="/note/assets/js/37.eb13d220.js"><link rel="prefetch" href="/note/assets/js/38.89868cb2.js"><link rel="prefetch" href="/note/assets/js/39.be3c9f32.js"><link rel="prefetch" href="/note/assets/js/4.995c7b0d.js"><link rel="prefetch" href="/note/assets/js/40.cae0677b.js"><link rel="prefetch" href="/note/assets/js/41.2df67b78.js"><link rel="prefetch" href="/note/assets/js/42.fa91e2ff.js"><link rel="prefetch" href="/note/assets/js/43.46fe60aa.js"><link rel="prefetch" href="/note/assets/js/44.320bba66.js"><link rel="prefetch" href="/note/assets/js/45.a0472922.js"><link rel="prefetch" href="/note/assets/js/46.1714d395.js"><link rel="prefetch" href="/note/assets/js/47.29f3bb79.js"><link rel="prefetch" href="/note/assets/js/48.fd6a7e73.js"><link rel="prefetch" href="/note/assets/js/49.abed58cc.js"><link rel="prefetch" href="/note/assets/js/5.d6d78d01.js"><link rel="prefetch" href="/note/assets/js/50.47799310.js"><link rel="prefetch" href="/note/assets/js/51.e59c994e.js"><link rel="prefetch" href="/note/assets/js/52.6ccc5c7a.js"><link rel="prefetch" href="/note/assets/js/53.5ad0bc53.js"><link rel="prefetch" href="/note/assets/js/55.06e399be.js"><link rel="prefetch" href="/note/assets/js/56.4762efc6.js"><link rel="prefetch" href="/note/assets/js/57.9c33ced4.js"><link rel="prefetch" href="/note/assets/js/58.c67de56c.js"><link rel="prefetch" href="/note/assets/js/59.dbb28d88.js"><link rel="prefetch" href="/note/assets/js/6.4e86f5c3.js"><link rel="prefetch" href="/note/assets/js/60.7014bee1.js"><link rel="prefetch" href="/note/assets/js/61.d7e7e0a2.js"><link rel="prefetch" href="/note/assets/js/62.2784e404.js"><link rel="prefetch" href="/note/assets/js/63.6ca8712f.js"><link rel="prefetch" href="/note/assets/js/64.883fbf61.js"><link rel="prefetch" href="/note/assets/js/65.dfbc2f4c.js"><link rel="prefetch" href="/note/assets/js/7.520b95b6.js"><link rel="prefetch" href="/note/assets/js/8.023e2b95.js"><link rel="prefetch" href="/note/assets/js/9.8d6f6bda.js">
    <link rel="stylesheet" href="/note/assets/css/0.styles.6ac3a915.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/note/" class="home-link router-link-active"><!----> <span class="site-name">Note</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/note/about.html" class="nav-link">About</a></div><div class="nav-item"><a href="/note/list.html" class="nav-link">Articles</a></div><div class="nav-item"><a href="/note/chukapi_fun_art.html" class="nav-link">Chukapi-Fun-Art</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/note/about.html" class="nav-link">About</a></div><div class="nav-item"><a href="/note/list.html" class="nav-link">Articles</a></div><div class="nav-item"><a href="/note/chukapi_fun_art.html" class="nav-link">Chukapi-Fun-Art</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Rustでシングルスレッドサーバを作ってみる</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/note/article/rust_example.html#_1-404-not-foundのページを作成する" class="sidebar-link">1. 404 NOT FOUNDのページを作成する</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/note/article/rust_example.html#_2-404-not-foundのページを設定する" class="sidebar-link">2. 404 NOT FOUNDのページを設定する</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="rustでシングルスレッドサーバを作ってみる"><a href="#rustでシングルスレッドサーバを作ってみる" aria-hidden="true" class="header-anchor">#</a> Rustでシングルスレッドサーバを作ってみる</h1> <p>以下に404 NOT FOUNDの実装を書いていきます。</p> <h2 id="_1-404-not-foundのページを作成する"><a href="#_1-404-not-foundのページを作成する" aria-hidden="true" class="header-anchor">#</a> 1. 404 NOT FOUNDのページを作成する</h2> <p>HTMLファイルに404 NOT FOUNDの旨を書けば良いです。</p> <p>一度作った<code>index.html</code>を真似して書いてみます。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- public/404.html --&gt;</span>
<span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>utf-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>404 NOT FOUND...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>I do not want to work...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>こんな感じで良いでしょう。</p> <h2 id="_2-404-not-foundのページを設定する"><a href="#_2-404-not-foundのページを設定する" aria-hidden="true" class="header-anchor">#</a> 2. 404 NOT FOUNDのページを設定する</h2> <p><code>src/main.rs</code>に追記すれば良いです。
設定したルーティング設定に引っかからなかったときに<code>404.html</code>を返せば良いので, そのように設定します。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// src/main.rs</span>

<span class="token comment">// ~~ 略 ~~</span>

<span class="token keyword">fn</span> <span class="token function">handle_connection</span><span class="token punctuation">(</span><span class="token keyword">mut</span> stream<span class="token punctuation">:</span> TcpStream<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// TcpStreamインスタンスのデータを読み取るためのバッファを用意</span>
  <span class="token keyword">let</span> <span class="token keyword">mut</span> buffer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  stream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> buffer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Request: {}&quot;</span><span class="token punctuation">,</span> String<span class="token punctuation">::</span><span class="token function">from_utf8_lossy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer<span class="token punctuation">[</span><span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> get <span class="token operator">=</span> <span class="token string">b&quot;GET / HTTP/1.1\r\n&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> buffer<span class="token punctuation">.</span><span class="token function">starts_with</span><span class="token punctuation">(</span>get<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> file <span class="token operator">=</span> File<span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;public/index.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> contents <span class="token operator">=</span> String<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    file<span class="token punctuation">.</span><span class="token function">read_to_string</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> contents<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> response <span class="token operator">=</span> <span class="token function">format!</span><span class="token punctuation">(</span><span class="token string">&quot;HTTP/1.1 200 OK\r\n\r\n{}&quot;</span><span class="token punctuation">,</span> contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
    stream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">as_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// streamに完全にwriteされるように, flush()を呼び出しておく</span>
    stream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span> <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>   <span class="token keyword">let</span> <span class="token keyword">mut</span> file <span class="token operator">=</span> File<span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;public/404.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>   <span class="token keyword">let</span> <span class="token keyword">mut</span> contents <span class="token operator">=</span> String<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>   file<span class="token punctuation">.</span><span class="token function">read_to_string</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> contents<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>
<span class="token operator">+</span>   <span class="token keyword">let</span> response <span class="token operator">=</span> <span class="token function">format!</span><span class="token punctuation">(</span><span class="token string">&quot;HTTP/1.1 404 NOT FOUND\r\n\r\n{}&quot;</span><span class="token punctuation">,</span> contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>   stream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">as_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>   <span class="token comment">// streamに完全にwriteされるように, flush()を呼び出しておく</span>
<span class="token operator">+</span>   stream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>以上です。これで<code>http://127.0.0.1:3000/</code>以外のURLでリクエストを飛ばすと, <code>public/404.html</code>の内容がレスポンスとして返されることが確認できると思います。</p> <h1 id="さらにリファクタリングしてみる"><a href="#さらにリファクタリングしてみる" aria-hidden="true" class="header-anchor">#</a> さらにリファクタリングしてみる</h1> <p>上のコードだとコードとして重複している部分が複数あります。
そこで, 重複している部分をまとめてみようと思います。</p> <p>よくコードを見ると, 異なっている部分はステータスコードとレスポンスとして返すファイルの場所のみであることがわかります。したがって, その2つを変数としてレスポンスを返してみます。</p> <p>コードは次の通りです。</p> <div class="language-rust extra-class"><pre class="language-rust"><code>src<span class="token operator">/</span>main<span class="token punctuation">.</span>rs

<span class="token comment">// ~~ 略 ~~</span>

<span class="token keyword">fn</span> <span class="token function">handle_connection</span><span class="token punctuation">(</span><span class="token keyword">mut</span> stream<span class="token punctuation">:</span> TcpStream<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// TcpStreamインスタンスのデータを読み取るためのバッファを用意</span>
  <span class="token keyword">let</span> <span class="token keyword">mut</span> buffer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  stream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> buffer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Request: {}&quot;</span><span class="token punctuation">,</span> String<span class="token punctuation">::</span><span class="token function">from_utf8_lossy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer<span class="token punctuation">[</span><span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> get <span class="token operator">=</span> <span class="token string">b&quot;GET / HTTP/1.1\r\n&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> <span class="token punctuation">(</span>status_line<span class="token punctuation">,</span> resource_path<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">if</span> buffer<span class="token punctuation">.</span><span class="token function">starts_with</span><span class="token punctuation">(</span>get<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token string">&quot;HTTP/1.1 200 OK\r\n\r\n&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;public/index.html&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token string">&quot;HTTP/1.1 404 NOT FOUND\r\n\r\n&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;public/404.html&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> <span class="token keyword">mut</span> file <span class="token operator">=</span> File<span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span>resource_path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token keyword">mut</span> contents <span class="token operator">=</span> String<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  file<span class="token punctuation">.</span><span class="token function">read_to_string</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> contents<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">let</span> response <span class="token operator">=</span> <span class="token function">format!</span><span class="token punctuation">(</span><span class="token string">&quot;{}{}&quot;</span><span class="token punctuation">,</span> status_line<span class="token punctuation">,</span> contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
  stream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">as_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// streamに完全にwriteされるように, flush()を呼び出しておく</span>
  stream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>お疲れ様でした。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">2019-9-4 11:56:11</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/note/assets/js/app.114b3125.js" defer></script><script src="/note/assets/js/2.a525c827.js" defer></script><script src="/note/assets/js/54.60a0737a.js" defer></script>
  </body>
</html>
